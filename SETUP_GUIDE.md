# Banner Stocker セットアップガイド

## 1. Google Apps Script (GAS) プロジェクトの作成

### GASエディタへのアクセス方法
1. Googleアカウントでログインした状態で
2. [Google Apps Script](https://script.google.com/) にアクセス
   - または、Google ドライブ → 新規 → その他 → Google Apps Script
3. これがGASエディタです。左側にファイル一覧、中央にコードエディタが表示されます

### プロジェクトの作成
1. 「新しいプロジェクト」をクリック
2. プロジェクト名を「Banner Stocker」に変更（左上の「無題のプロジェクト」をクリック）

### エディタの主な機能
- メニューバー：「表示」「実行」「デバッグ」などの操作
- ファイル一覧：左側のサイドバーで`.gs`ファイルを管理
- エディタ：中央でコードを編集
- ログビューア：下部に実行ログを表示（表示 → 実行ログ）
- デプロイ管理：右上の「デプロイ」ボタン

## 2. コードの実装

以下の3つのファイルを作成し、それぞれコードを実装します：

1. `Code.gs` - メインの処理を行うファイル
2. `Spreadsheet.gs` - スプレッドシート操作に関する関数を含むファイル
3. `Chatwork.gs` - Chatwork API関連の関数を含むファイル

※ GASでは同じプロジェクト内の.gsファイルは自動的に結合されるため、
ファイル間でのimport文は必要ありません。全ての関数はグローバルスコープで
利用可能です。

## 3. Google Drive APIの有効化

1. GASエディタの「サービス」をクリック
2. 「サービスを追加」をクリック
3. リストから「Drive API」を選択して「追加」をクリック
4. 必要な権限を承認

1. [Google Cloud Console](https://console.cloud.google.com/)にアクセス
2. 新しいプロジェクトを作成（または既存のプロジェクトを選択）
   - 右上のプロジェクト選択 → 「新しいプロジェクト」
   - プロジェクト名を入力（例：「Banner Stocker」）
   - 「作成」をクリック
3. 左側メニューから「APIとサービス」→「ライブラリ」を選択
4. 検索バーで「Google Drive API」を検索
5. Google Drive APIを選択し、「有効にする」をクリック
6. 「OAuth同意画面」の設定
   - 「外部」を選択し、「作成」
   - アプ��名、ユーザーサポートメール、デベロッパーの連絡先情報を入力
   - 必要に応じてスコープを追加（Drive APIの読み書き権限）
7. 認証情報の作成
   - 「認証情報」→「認証情報を作成」→「OAuthクライアントID」
   - アプリケーションの種類：「デスクトップアプリ」
   - 名前を入力（例：「Banner Stocker Client」）
   - 作成されたクライアントIDとクライアントシークレットを保存

### 3.2 GASプロジェクトでの設定

1. GASエディタの「プロジェクトの設定」をクリック
2. 「Google Cloud Platform (GCP) プロジェクト」セクションで
   - 「変更」をクリック
   - 先ほど作成したプロジェクトを選択
3. 「サービス」をクリック
4. 「サービスを追加」をクリック
5. リストから「Drive API」を選択して「追加」

※ Google Driveへのアクセス権限が要求されますが、これは画像の保存と
共有設定のために必要です。自動作成される`BannerStock Images`フォルダ内の
画像ファイルは、スプレッドシートでプレビュー表示できるように自動的に
「リンクを知っている人はでも閲覧可能」に設定されます。

## 4. Google Sheets APIの有効化

1. 同じく「サービス」から
2. 「サービスを追加」をクリック
3. 「Sheets API」を選択して「追加」をクリック

## 5. Chatwork APIトークンの取得

1. [Chatworkの開発者ページ](https://www.chatwork.com/service/packages/chatwork/subpackages/api/token.php)にアクセス
2. 「新しいAPIトークンを発行する」をクリック
3. 以下の権限を選択：
   - `rooms.messages.read`
   - `rooms.files.read`
4. 発行されたAPIトークンをコピー

## 6. スクリプトプロパティの設定

1. GASエディタの「プロジェクトの設定」をクリック
2. 「スクリプトプロパティ」セクションで「プロパティを追加」をクリック
3. 以下の設定を追加：
   - プロパティ：`CHATWORK_API_TOKEN`
   - 値：コピーしたAPIトークン

## 7. GASのデプロイ

1. 「デプロイ」→「新しいデプロイ」をクリック
2. 「種類の選択」で「ウェブアプリ」を選択
3. 以下の設定を行う：
   - 説明：「Banner Stocker Webhook Endpoint」
   - 次のユーザーとして実行：「自分」
   - アクセスできるユーザー：「全員」
4. 「デプロイ」をクリック
5. 必要な権限を承認
6. デプロイされたURLをコピー

## 8. Chatwork Webhookの設定

1. Chatworkの対象チャットルームの設定を開く
2. 「Webhook」タブを選択
3. 「Webhook URL追加」をクリック
4. 以下の設定を行う：
   - Webhook名：「Banner Stocker」
   - Endpoint URL：GASでデプロイしたURL
   - イベント：「メッセージ作成」を選択
5. 「追加」をクリック

※ ChatworkはWebhookの健全性確認のため定期的にGETリクエストを送信します。
これは正常な動作であり、実行ログに`doGet`の実行が記録されるのは問題ありません。

## 9. スプレッドシートの準備

1. 新しいGoogle スプレッドシートを作成
2. スプレッドシート名を「Banner Stock」に変更
3. GASプロジェクトのコードでこのスプレッドシートのIDを設定

※ Google Drive上に`BannerStock Images`フォルダが自動的に作成され、
バナー画像はこのフォルダに保存されます。手動でフォルダを作成する必要はありません。

## 10. 動作確認

1. Chatworkの対象ルームで以下の形式でメッセージを投稿：
   ```
   [バナー画像を添付]
   https://example.com/lp-url
   ジャンル：美容
   ```
2. スプレッドシートを確認し、以下が登録されていることを確認：
   - 投稿日時
   - バナー画像（プレビュー）
   - LP URL
   - ジャンル

## トラブルシューティング

### よくあるエラー

1. **画像が表示されない**
   - Google Driveの共有設定を確認
   - スプレッドシートのIMAGE関数の動作を確認

2. **Webhookが動作しない**
   - デプロイしたURLが正しいか確認
   - Webhookの設定が有効になっているか確認

3. **APIエラー**
   - APIトークンの有効期限を確認
   - スクリプトプロパティが正しく設定されているか確認

### ログの確認方法

#### GASエディタでのログ表示方法
1. GASエディタ（script.google.com）を開く
2. 画面上部のメニューから「表示」をクリック
3. 「実行ログ」を選択
   - または、キーボードショートカット `Cmd + Enter`（Mac）/ `Ctrl + Enter`（Windows）
4. 画面下部にログビューアが表示されます

#### ログビューアの使い方
- 更新ボタン：最新のログを取得
- クリアボタン：ログをクリア
- フィルター：特定の文字列でログを絞り込み
- エクスポート：ログをテキストファイルとして保存

#### ログの見方
- 日時：実行された時刻
- 関数名：実行された関数
- ログメッセージ：
  - `console.log()` で出力された情報
  - エラーメッセージ
  - 実行結果など

#### 主なログ内容
- `doGet`の実行：Webhookのヘルスチェック（正常）
- `doPost`の実行：メッセージ受信時の処理
- `Required information missing`：必要な情報が不足
- `Error extracting image URL`：画像取得時のエラー

#### ログの保存期間
- 実行ログは一定期間保存されます
- 古いログは自動的に削除されます
- 重要なログは必要に応じてコピーして保存することを推奨

## 料金と権限に関する注意事項

### 利用料金について
- Google Apps ScriptとGoogle APIの基本的な使用は無料です
- 無料枠の制限：
  - Drive API: 1日あたり約1,000回のリクエスト
  - Sheets API: 1日あたり約500回のリクエスト
  - 通常の使用では十分な量です

### OAuth同意画面の設定
以下のいずれかの方法を選択してください：

1. **推奨: GASのデフォルト設定を使用**
   - GCPプロジェクトの紐付けを解除
   - GASのデフォルトの認証システムを使用
   - 追加の設定は不要

2. **代替: GCPプロジェクトを使用する場合**
   - OAuth同���画面は「内部」テストとして設定
   - テストユーザーとして必要なユーザーのみを追加
   - 公開設定は不要

### セキュリティに関する推奨事項
- アクセス権限は必要最小限に設定
- 共有設定は必要なユーザーのみに制限
- 定期的にアクセス権限を見直し
