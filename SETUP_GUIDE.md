# Banner Stocker セットアップガイド

## 1. Google Apps Script (GAS) プロジェクトの作成

1. [Google Apps Script](https://script.google.com/) にアクセス
2. 「新しいプロジェクト」をクリック
3. プロジェクト名を「Banner Stocker」に変更

## 2. コードの実装

以下の3つのファイルを作成し、それぞれコードを実装します：

1. `Code.gs` - メインの処理を行うファイル
2. `Spreadsheet.gs` - スプレッドシート操作に関する関数を含むファイル
3. `Chatwork.gs` - Chatwork API関連の関数を含むファイル

※ GASでは同じプロジェクト内の.gsファイルは自動的に結合されるため、
ファイル間でのimport文は必要ありません。全ての関数はグローバルスコープで
利用可能です。

## 3. Google Drive APIの有効化

### 3.1 Google Cloud Consoleでの設定

1. [Google Cloud Console](https://console.cloud.google.com/)にアクセス
2. 新しいプロジェクトを作成（または既存のプロジェクトを選択）
   - 右上のプロジェクト選択 → 「新しいプロジェクト」
   - プロジェクト名を入力（例：「Banner Stocker」）
   - 「作成」をクリック
3. 左側メニューから「APIとサービス」→「ライブラリ」を選択
4. 検索バーで「Google Drive API」を検索
5. Google Drive APIを選択し、「有効にする」をクリック
6. 「OAuth同意画面」の設定
   - 「外部」を選択し、「作成」
   - アプリ名、ユーザーサポートメール、デベロッパーの連絡先情報を入力
   - 必要に応じてスコープを追加（Drive APIの読み書き権限）
7. 認証情報の作成
   - 「認証情報」→「認証情報を作成」→「OAuthクライアントID」
   - アプリケーションの種類：「デスクトップアプリ」
   - 名前を入力（例：「Banner Stocker Client」）
   - 作成されたクライアントIDとクライアントシークレットを保存

### 3.2 GASプロジェクトでの設定

1. GASエディタの「プロジェクトの設定」をクリック
2. 「Google Cloud Platform (GCP) プロジェクト」セクションで
   - 「変更」をクリック
   - 先ほど作成したプロジェクトを選択
3. 「サービス」をクリック
4. 「サービスを追加」をクリック
5. リストから「Drive API」を選択して「追加」

※ Google Driveへのアクセス権限が要求されますが、これは画像の保存と
共有設定のために必要です。自動作成される`BannerStock Images`フォルダ内の
画像ファイルは、スプレッドシートでプレビュー表示できるように自動的に
「リンクを知っている人は誰でも閲覧可能」に設定されます。

## 4. Google Sheets APIの有効化

1. 同じく「サービス」から
2. 「サービスを追加」をクリック
3. 「Sheets API」を選択して「追加」をクリック

## 5. Chatwork APIトークンの取得

1. [Chatworkの開発者ページ](https://www.chatwork.com/service/packages/chatwork/subpackages/api/token.php)にアクセス
2. 「新しいAPIトークンを発行する」をクリック
3. 以下の権限を選択：
   - `rooms.messages.read`
   - `rooms.files.read`
4. 発行されたAPIトークンをコピー

## 6. スクリプトプロパティの設定

1. GASエディタの「プロジェクトの設定」をクリック
2. 「スクリプトプロパティ」セクションで「プロパティを追加」をクリック
3. 以下の設定を追加：
   - プロパティ：`CHATWORK_API_TOKEN`
   - 値：コピーしたAPIトークン

## 7. GASのデプロイ

1. 「デプロイ」→「新しいデプロイ」をクリック
2. 「種類の選択」で「ウェブアプリ」を選択
3. 以下の設定を行う：
   - 説明：「Banner Stocker Webhook Endpoint」
   - 次のユーザーとして実行：「自分」
   - アクセスできるユーザー：「全員」
4. 「デプロイ」をクリック
5. 必要な権限を承認
6. デプロイされたURLをコピー

## 8. Chatwork Webhookの設定

1. Chatworkの対象チャットルームの設定を開く
2. 「Webhook」タブを選択
3. 「Webhook URL追加」をクリック
4. 以下の設定を行う：
   - Webhook名：「Banner Stocker」
   - Endpoint URL：GASでデプロイしたURL
   - イベント：「メッセージ作成」を選択
5. 「追加」をクリック

※ ChatworkはWebhookの健全性確認のため定期的にGETリクエストを送信します。
これは正常な動作であり、実行ログに`doGet`の実行が記録されるのは問題ありません。

## 9. スプレッドシートの準備

1. 新しいGoogle スプレッドシートを作成
2. スプレッドシート名を「Banner Stock」に変更
3. GASプロジェクトのコードでこのスプレッドシートのIDを設定

※ Google Drive上に`BannerStock Images`フォルダが自動的に作成され、
バナー画像はこのフォルダに保存されます。手動でフォルダを作成する必要はありません。

## 10. 動作確認

1. Chatworkの対象ルームで以下の形式でメッセージを投稿：
   ```
   [バナー画像を添付]
   https://example.com/lp-url
   ジャンル：美容
   ```
2. スプレッドシートを確認し、以下が登録されていることを確認：
   - 投稿日時
   - バナー画像（プレビュー）
   - LP URL
   - ジャンル

## トラブルシューティング

### よくあるエラー

1. **画像が表示されない**
   - Google Driveの共有設定を確認
   - スプレッドシートのIMAGE関数の動作を確認

2. **Webhookが動作しない**
   - デプロイしたURLが正しいか確認
   - Webhookの設定が有効になっているか確認

3. **APIエラー**
   - APIトークンの有効期限を確認
   - スクリプトプロパティが正しく設定されているか確認

### ログの確認方法

1. GASエディタの「表示」→「実行ログ」を選択
2. エラーメッセージを確認
